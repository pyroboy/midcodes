# Story 1.1: Credit Security Fix

## Status
Draft

## Story
**As a** system administrator,  
**I want** proper authorization checks on all credit bypass functions,  
**so that** unauthorized users cannot bypass payment systems and gain credits illegally.

## Acceptance Criteria
1. All credit bypass functions (`addCreditsBypass`, `grantFeatureBypass`) require proper role authorization
2. Only users with `super_admin` or `org_admin` roles can execute bypass functions  
3. All bypass attempts are logged with user details and timestamps
4. Unauthorized bypass attempts are blocked and logged as security events
5. Existing functionality remains intact for authorized admin users

## Tasks / Subtasks
- [ ] **Task 1: Add Authorization Middleware to Bypass Functions** (AC: 1, 2, 4)
  - [ ] Add role validation check to `addCreditsBypass` function
  - [ ] Add role validation check to `grantFeatureBypass` function  
  - [ ] Return proper error messages for unauthorized access attempts
  - [ ] Add audit logging for all bypass attempts (successful and failed)
- [ ] **Task 2: Secure API Endpoints Using Bypass Functions** (AC: 1, 2, 4)
  - [ ] Review all API routes that call bypass functions
  - [ ] Add server-side authorization checks in route handlers
  - [ ] Implement proper error responses for unauthorized requests
- [ ] **Task 3: Add Security Event Logging** (AC: 3, 4) 
  - [ ] Create security audit log table if needed
  - [ ] Log all bypass function calls with user context
  - [ ] Log unauthorized access attempts with IP and user details
- [ ] **Task 4: Unit Tests for Security Functions** (AC: 1, 2, 4, 5)
  - [ ] Test authorized user can use bypass functions
  - [ ] Test unauthorized user gets blocked from bypass functions
  - [ ] Test audit logging works correctly
  - [ ] Test existing functionality unchanged for authorized users

## Dev Notes

### Previous Story Insights
This is the first story in the epic, no previous story context available.

### Security Context
- **Current Vulnerability**: Bypass functions in `src/lib/server/credits/bypass-helpers.ts` lack proper authorization checks
- **Risk Level**: Critical - unauthorized users could potentially gain free credits
- **Impact**: Financial loss, system integrity compromise

### Data Models and Security Requirements
- **Role Hierarchy**: `super_admin` > `org_admin` > `id_gen_admin` > `id_gen_user` [Source: CLAUDE.md role documentation]
- **Authorization Levels**: Only `super_admin` and `org_admin` should access bypass functions
- **Audit Trail**: All credit transactions already logged in `credit_transactions` table [Source: credits.ts:327-342]

### API Specifications
- **Bypass Functions Location**: `src/lib/server/credits/bypass-helpers.ts` 
  - `addCreditsBypass()` - Adds credits without payment [Source: bypass-helpers.ts:26-101]
  - `grantFeatureBypass()` - Grants premium features without payment [Source: bypass-helpers.ts:106-183]
- **Authorization Pattern**: Check user role against org_id before executing bypass logic

### Component Specifications  
- **Admin Interface**: `src/routes/admin/credits/+page.svelte` already exists and working [Source: admin/credits/+page.svelte]
- **Backend Validation**: Server-side route protection needed in API endpoints calling bypass functions
- **Error Handling**: Standardized error responses for unauthorized access

### File Locations
- **Security Functions**: `src/lib/server/credits/bypass-helpers.ts` (modify existing)
- **API Routes**: Check `src/routes/api/` for any endpoints using bypass functions 
- **Auth Utils**: `src/lib/server/` directory for reusable authorization helpers
- **Tests**: `tests/unit/credit-security.test.ts` (new file)

### Technical Constraints
- **Supabase RLS**: Work with existing Row Level Security policies [Source: CLAUDE.md database notes]
- **Organization Scoping**: All operations must be organization-scoped via `org_id` [Source: CLAUDE.md data access patterns]
- **Session Management**: Use existing auth patterns from `src/lib/stores/auth.ts` [Source: project structure]

### Testing
- **Test Location**: `tests/unit/` directory [Source: CLAUDE.md testing strategy]  
- **Test Framework**: Vitest with Testing Library [Source: CLAUDE.md testing strategy]
- **Security Test Focus**: Authorization checks, audit logging, role validation
- **Integration Tests**: May need to test with real Supabase instance [Source: existing test patterns]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-24 | 1.0 | Initial story creation | BMad System |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References  
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be added here*