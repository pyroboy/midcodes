# Story 1.2: Enhanced Admin Credit Management Interface

## Status

Draft

## Story

**As a** system administrator,  
**I want** a simple, direct interface to manually adjust user credits,  
**so that** I can quickly resolve billing issues and provide customer support without complex UI/UX overhead.

## Acceptance Criteria

1. Admin interface displays all users with their current credit balances in a simple table
2. Each user row has input fields for credit adjustment (positive/negative values) and reason
3. "Apply" button immediately updates user credits and refreshes the display
4. All manual adjustments create proper audit trail entries in credit_transactions
5. Interface works without fancy UI/UX - just functional inputs and buttons
6. Only users with admin roles (super_admin, org_admin, id_gen_admin) can access this interface

## Tasks / Subtasks

- [ ] **Task 1: Enhance User Data Display** (AC: 1)
  - [ ] Add columns for better user identification (email, role, organization)
  - [ ] Show current credit balance, card generation count, premium features
  - [ ] Add basic sorting/filtering capabilities for large user lists
- [ ] **Task 2: Simplify Credit Adjustment Interface** (AC: 2, 3, 5)
  - [ ] Keep existing simple input fields for credit delta (+/- values)
  - [ ] Keep existing reason input field
  - [ ] Ensure "Apply" button is clearly visible and functional
  - [ ] Add basic validation for numeric inputs
- [ ] **Task 3: Improve Backend Credit Adjustment Function** (AC: 3, 4)
  - [ ] Enhance `adjustUserCredits` function in `admin/billing.remote.ts`
  - [ ] Ensure proper audit trail creation for manual adjustments
  - [ ] Add proper error handling and user feedback
  - [ ] Validate admin permissions on backend
- [ ] **Task 4: Add Authorization Checks** (AC: 6)
  - [ ] Verify route protection in `+page.server.ts` for admin roles only
  - [ ] Add role-based UI elements (hide interface from non-admins)
  - [ ] Test access controls work correctly
- [ ] **Task 5: Basic Testing** (AC: 1, 2, 3, 4, 6)
  - [ ] Test credit adjustments with positive values
  - [ ] Test credit adjustments with negative values
  - [ ] Test audit trail entries are created correctly
  - [ ] Test admin access controls work
  - [ ] Test error handling for invalid inputs

## Dev Notes

### Previous Story Insights

- Story 1.1 created security improvements for bypass functions
- Authorization patterns established in previous story can be reused

### Current Interface Analysis

- **Existing File**: `src/routes/admin/credits/+page.svelte` already functional [Source: admin/credits/+page.svelte]
- **Current Features**: Basic table display, input fields for delta/reason, apply button
- **Current Backend**: `adjustUserCredits` function exists in `admin/billing.remote.ts` [Source: +page.svelte:10]

### Data Models

- **User Credits**: Available from `profiles` table via `getUsersWithCredits()` [Source: +page.svelte:12]
- **Credit Fields**: `credits_balance`, `card_generation_count`, `unlimited_templates`, `remove_watermarks` [Source: credits.ts:18-24]
- **Transaction Logging**: Uses `credit_transactions` table for audit trail [Source: credits.ts:3-16]

### API Specifications

- **Data Fetching**: `getUsersWithCredits()` from `admin/billing.remote.ts` [Source: +page.svelte:12]
- **Credit Adjustment**: `adjustUserCredits({userId, delta, reason})` [Source: +page.svelte:23]
- **Response Handling**: Basic error logging exists [Source: +page.svelte:28-30]

### Component Specifications

- **UI Library**: Uses shadcn-svelte components (Card, CardHeader, etc.) [Source: +page.svelte:2-8]
- **Layout**: Simple table-like structure with flex layout [Source: +page.svelte:56-77]
- **Input Types**: Number input for credit delta, text input for reason [Source: +page.svelte:64-74]
- **State Management**: Local component state for deltas and reasons [Source: +page.svelte:15-16]

### File Locations

- **Main Component**: `src/routes/admin/credits/+page.svelte` (modify existing)
- **Backend Logic**: `src/routes/admin/billing.remote.ts` (enhance existing)
- **Route Protection**: `src/routes/admin/credits/+page.server.ts` (verify existing or create)
- **Tests**: `tests/unit/admin-credits.test.ts` (new file)

### Technical Constraints

- **Role-Based Access**: Admin roles only (`super_admin`, `org_admin`, `id_gen_admin`) [Source: CLAUDE.md role hierarchy]
- **Organization Scoping**: All operations organization-scoped [Source: CLAUDE.md data access patterns]
- **UI Requirements**: Deliberately simple - no fancy UI/UX [Source: user requirements]
- **Existing Patterns**: Follow current SvelteKit + Supabase patterns [Source: project structure]

### Authorization Requirements

- **Server-side Protection**: `requireAuth()` in `+page.server.ts` [Source: CLAUDE.md route protection patterns]
- **Role Validation**: Check user role against admin hierarchy [Source: CLAUDE.md role implementation]
- **Organization Context**: Ensure admin can only manage users in their org [Source: CLAUDE.md data scope]

### Testing

- **Test Location**: `tests/unit/` directory [Source: CLAUDE.md testing strategy]
- **Test Framework**: Vitest with Testing Library [Source: CLAUDE.md testing strategy]
- **Focus Areas**: Credit adjustment logic, audit trail creation, access controls, UI interactions
- **Integration Testing**: Test with actual Supabase instance [Source: existing test patterns]

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-24 | 1.0     | Initial story creation | BMad System |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be added here_
